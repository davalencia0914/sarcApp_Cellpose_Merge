# sarcApp_Cellpose_Merge
Python-based code that makes Cellpose segmentations (https://github.com/MouseLand/cellpose) compatible with sarcApp (by abbieneininger). (Link to sarcApp repository: https://github.com/abbieneininger/sarcApp)

# Protocol
1. First download and install both Cellpose and sarcApp from the respective links above
2. Segment cells normally as described by Cellpose.
3. Images can be processed with an imageJ macros titled "DAV_1Color_Macro.txt" to extract and save the single channel of interest, whether its of alpha-actinin, myomesin, or titin, to be used for the downstream binarization by yoU-Net for sarcApp.
4. The NPY files that are saved after segmentation by Cellpose are then used in the cellposeEdge_ACNC_DAV_Whole_Segment.txt file that is run on ipython in the terminal. Run the function cellposeEdge(npy_file, outputFolder, count, xres) with the proper inputs for outputFolder and xres (xres can be acquired from the metadata for the correct spatial resolution scaling of your image) npy_file is correctly stored in a dictionary in the cellposeEdge_ACNC_DAV_Whole_Segment.txt file as long as folder paths are correct
5. As a result, pickle objects for each individual cell should be saved into the designated output folder
6. Run the imageJ macros titled, "imagej_roi_converter_preSarcApp_CSV_Data.py" which is merging the Cellpose Python script imagej_roi_converter.py and iterating through each file in the indicated folder and each ROI in each binarized image to threshold and perform particle analysis on. Each individual ROI measurements are saved in a separate csv and stored in an output folder (the macro automatically skips small ROIs less than the specified area that are undersegmented artifacts from Cellpose, while maintaining the ROI numbering on imageJ from the txt outlines).
7. Make sure to have all the necessary measurements set on imageJ (Area, min & max gray value, bounding rectangle, shape descriptors, fit ellipse (in Python: area centroid bounding fit shape feret's integrated)), which should be done by the program too.
8. If it's desired to get more measurements from a similar imageJ macros as in step 6, such as exogenous protein fluorescence or reporter fluorescence normalized by cell segment area, then run the imageJ macros titled, "imagej_roi_converter_HAFHOD3L_CSV_Data.py" or the "_SingleCell" equivalent. Make sure the channel numbers are correct as imageJ is 0-indexed.
9. Although not entirely accurate, since the field of view of a given image of cardiomyocytes may contain fibroblasts and other cell types we don't care about, the Python script titled, "Exclude_Non_NRCs.py" can be run on ipython in the terminal to remove ROI segments that have fewer than a specified number of particles analyzed (if using alpha-actinin as a stain, you can set a threshold number of measurements that may just be background and thus not from an actual cardiomyocyte).
10. For some reason, this updated merged code requires renumbering the filenames of the binarized images you want to input into sarcApp and thus both the folder for the CSV data files and the pickle objects from the segmentation should be duplicated so that the original filenames are preserved.
11. Then run the script titled, "Coding_Filenames_Numbered_pickle.py" through an ipython terminal for the pickle objects to be renamed and a similar script titled, "Coding_Filenames_Numbered_CSV.py" for the CSV file renaming. These scripts output a key filename CSV file for later reference. In the future, a for loop to iterate through and find the base names of the files with their original names should definitely be possible, but the code worked by defaulting the CSV and pickle objects to be similarly numbered 0-N for N number of CSV/pickle files. You can see my attempts at this in the updated actininFixed2D.py file.
12. For some odd reason currently, the CellposeEdge_ACNC.py file seems to run first when trying to directly run sarcApp.py from the terminal. To get around this since it has to be run prior, you can just break the input and output directories in the file itself beforehand, such that it will skip straight to the sarcApp GUI to move forward.
13. On the second GUI that pops up after starting sarcApp, you need to enter the data folder as the filepath that you saved the CSV files to from the imageJ measurements off the binarized images (step 6). The “Output Folder” is the same folder you had saved all the pickle objects in that contain the coordinates of the ROIs/cells from the image.
14. To help with data management after sarcApp runs, I wrote short Python scripts that can be run on ipython terminals to merge each set of the 3 possible CSV files based on an input prefix filename titled, “CSV_Merge.py” (for cellResults,  msfResults, and mfResults).
15. "DAV_postSarcApp_CSV_Cleanup.txt" can be put into ipython on the terminal with the correct filepath to the CSV file that you want to delete the excess headers from that carry over from the CSV_Merge.py script.
Notes: The same regions of actininMain and actininFixed2D.py would need to be amended if using myomesin or titin for measurements by sarcApp. 


